<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>GSAP ScrollTrigger æ¨ªå‘è”åŠ¨ç¤ºä¾‹</title>
        <style>
            ::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
            html,
            body {
                height: 100%;
                margin: 0;
            }
            .btn-wrapper {
                position: fixed;
                display: flex;
                flex-direction: row;
                align-items: center;
                width: 100vw;
                height: 60px;
                justify-content: center;
                bottom: 15%;
            }
            .btn {
                width: 20vw;
                height: 50px;
            }

            #app-wrapper {
                width: 100vw;
                overflow-x: hidden;
            } /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨æ¡å‡ºç° */

            .space {
                width: 100%;
                height: 100vh;
                background-color: yellowgreen;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2rem;
            }

            /* æ¨ªå‘ç»„ä»¶å®¹å™¨ï¼šé«˜åº¦æ’‘æ»¡è§†å£ï¼ˆæˆ–ä½ æƒ³è¦çš„é«˜åº¦ï¼‰ */
            #horizontal-area {
                height: 100vh; /* è®© pin æ—¶å æ®æ•´å±é«˜åº¦ï¼Œé¿å…ä¸Šä¸‹å†…å®¹å‡ºç°ç¼éš™ */
                display: flex;
                /* ä¸è®¾ç½®å›ºå®šå®½åº¦ï¼Œè®©å†…éƒ¨æŒ‰ 100vw å¸ƒå±€ */
                overflow: hidden; /* éšè—æº¢å‡ºçš„æ¨ªå‘å†…å®¹ï¼ˆè¢«åŠ¨ç”»ç§»åŠ¨ï¼‰ */
                box-sizing: border-box;
                align-items: center;
            }

            /* æ¯ä¸ªâ€œé¡µé¢â€å æ»¡è§†å£å®½åº¦ï¼Œä¸”ä¸æ”¶ç¼© */
            .step-horizontal {
                height: 100vh; /* å†…éƒ¨å†…å®¹é«˜åº¦ï¼ˆå¯è°ƒæ•´ï¼‰ */
                width: 100vw; /* å…³é”®ï¼šå æ»¡è§†å£å®½åº¦ */
                flex: 0 0 100vw; /* é˜»æ­¢ç¼©æ”¾æˆ–æ”¶ç¼©ï¼Œä¿è¯æ¨ªå‘é“ºæ»¡ */
                font-size: larger;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                box-sizing: border-box;
                margin: 0;
            }

            .controller {
                position: fixed;
                bottom: 0;
                width: 100vw;
                z-index: 50;
                height: 300px;
                display: flex;
                gap: 10px;
                justify-content: center;
                align-items: center;
            }

            .controller > button {
                width: 200px;
                height: 70px;
                font-size: 20px;
            }
        </style>
    </head>
    <body>
        <div class="controller">
            <button id="btn-prev">prev</button>
            <button id="btn-test">test</button>
            <button id="btn-next">next</button>
        </div>
        <div id="app-wrapper">
            <div id="app-content">
                <div id="step-0" class="space step-vertical">ä¸Šæ–¹å†…å®¹ - step 0</div>

                <!-- å·¦å³æ»‘åŠ¨å†…å®¹ -->
                <div id="horizontal-area">
                    <div class="step-horizontal" id="step-1" style="background-color: #78c3f4">step1</div>
                    <div class="step-horizontal" id="step-2" style="background-color: #f1fa93">step2</div>
                    <div class="step-horizontal" id="step-3" style="background-color: #fc67a0">step3</div>
                    <div class="step-horizontal" id="step-4" style="background-color: #85fcf6">step4</div>
                    <div class="step-horizontal" id="step-5" style="background-color: #c48afc">step5</div>
                    <div class="step-horizontal" id="step-6" style="background-color: #38df93">step6</div>
                </div>

                <div class="space step-vertical">ä¸‹æ–¹å†…å®¹ - step 2</div>
            </div>
        </div>
        <script src="./asset/js/gsap@3.13.0/ScrollTrigger.min.js"></script>
        <script src="./asset/js/gsap@3.13.0/ScrollSmoother.min.js"></script>
        <script src="./asset/js/gsap@3.13.0/gsap.min.js"></script>

        <script type="text/javascript">
            gsap.registerPlugin(ScrollTrigger, ScrollSmoother);
            const smoother = ScrollSmoother.create({
                wrapper: "#app-wrapper",
                content: "#app-content",
                smooth: 2.5, // æ»šåŠ¨ç³»æ•°ï¼Œæ•°å€¼è¶Šå¤§ï¼Œæ»‘åŠ¨æƒ¯æ€§è¶Šå¤§ 1.5~3 ä¹‹é—´å·²ç»å¾ˆä¸æ»‘
            });

            window.CpsScroller = {
                allElement: document.querySelectorAll(".step"),
                trigger: null, // ScrollTrigger å®ä¾‹ï¼ˆä¼šåœ¨ init æ—¶èµ‹å€¼ï¼‰
                smoother, // ScrollSmoother å®ä¾‹
                pageCount: 0, // é¡µé¢æ•°é‡ï¼ˆæ¨ªå‘é¡µæ•°ï¼‰
                horizontalDistance: 0, // æ€»çš„æ¨ªå‘å¯¹åº”çš„å‚ç›´æ»šåŠ¨è·ç¦»ï¼ˆæ€»é•¿åº¦ï¼‰
                currentPage: 0, // å½“å‰é¡µï¼ˆåŠ¡å¿…ä¿æŒä¸º numberï¼‰
                sections: [], // string<HTMLDivElement>[]
                pagePositions: [], // é¡µé¢ä½ç½®æ•°ç»„
                isAutoScrolling: false, // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨æ»šåŠ¨
                velocityThreshold: 50, // é€Ÿåº¦é˜ˆå€¼ï¼Œä½äºæ­¤å€¼è®¤ä¸ºæ»šåŠ¨åœæ­¢
                scrollTimeout: null, // æ»šåŠ¨è¶…æ—¶è®¡æ—¶å™¨
            };
        </script>

        <!-- é¡µé¢æ»šåŠ¨åŠŸèƒ½ -->
        <script>
            function initCpsScroller() {
                const container = document.querySelector("#horizontal-area"); // æ¨ªå‘æ»šåŠ¨çš„å®¹å™¨
                const sections = document.querySelectorAll(".step-horizontal"); // æ¨ªå‘æ»šåŠ¨çš„å…ƒç´ 

                // è®¡ç®—æ¨ªå‘éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼šæ€»å®½ - å¯è§å®½
                const horizontalDistance = container.scrollWidth - window.innerWidth;

                // æ¸…ç†ä¹‹å‰çš„ ScrollTriggersï¼ˆçƒ­é‡è½½/è°ƒè¯•æ—¶ç”¨ï¼‰
                ScrollTrigger.getAll().forEach((st) => st.kill());

                // åˆ›å»ºæ¨ªå‘åŠ¨ç”»ï¼ˆç§»åŠ¨æ‰€æœ‰ section çš„ xï¼‰
                const scrollTrigger = gsap.to(sections, {
                    xPercent: -100 * (sections.length - 1),
                    ease: "none",
                    scrollTrigger: {
                        id: "horizontalScroll",
                        trigger: container,
                        start: "top top",
                        end: () => "+=" + horizontalDistance, // ç²¾ç¡®åŒ¹é…éœ€è¦çš„å‚ç›´æ»šåŠ¨è·ç¦»
                        pin: true,
                        scrub: true,
                        anticipatePin: 1,
                        invalidateOnRefresh: true,
                    },
                }).scrollTrigger;

                // ScrollTrigger ä¼šåœ¨ resize æ—¶è‡ªåŠ¨ refresh
                window.addEventListener("resize", () => ScrollTrigger.refresh());

                // æš´éœ²åˆ°å…¨å±€
                window.CpsScroller.trigger = scrollTrigger;
                window.CpsScroller.pageCount = sections.length;
                window.CpsScroller.horizontalDistance = horizontalDistance;
            }
        </script>

        <!-- é¡µé¢æ§åˆ¶éƒ¨åˆ† -->
        <script>
            const initPagingControls = () => {
                const scroller = window.CpsScroller;
                const { smoother } = scroller;

                scroller.sections = document.querySelectorAll(".step-horizontal");
                scroller.pageCount = scroller.sections.length + 1; // åŒ…å« step-0
                scroller.currentPage = 0;

                function computePagePositions() {
                    const { trigger, sections, horizontalDistance } = window.CpsScroller;
                    const pagePositions = [0]; // step-0 æ°¸è¿œæ˜¯é¡¶éƒ¨

                    const pagesInside = sections.length;
                    const segment = horizontalDistance / (pagesInside - 1);

                    for (let i = 0; i < pagesInside; i++) {
                        pagePositions.push(trigger.start + segment * i);
                    }

                    CpsScroller.pagePositions = pagePositions;
                }

                computePagePositions();
                window.addEventListener("resize", computePagePositions);

                function goToPage(index) {
                    index = Math.max(0, Math.min(index, scroller.pageCount - 1));
                    scroller.currentPage = index;
                    scroller.isAutoScrolling = true;
                    smoother.scrollTo(scroller.pagePositions[index], true);
                    console.log(`ğŸ“ å‰å¾€ç¬¬ ${index} é¡µ â†’ scrollTo(${scroller.pagePositions[index]})`);

                    // 300msåé‡ç½®è‡ªåŠ¨æ»šåŠ¨æ ‡è®°ï¼ˆç»™åŠ¨ç”»ä¸€äº›æ—¶é—´ï¼‰
                    setTimeout(() => {
                        scroller.isAutoScrolling = false;
                    }, 300);
                }

                // æ‰¾åˆ°æœ€è¿‘çš„é¡µé¢ç´¢å¼•
                function findNearestPage(currentPos) {
                    const { pagePositions } = scroller;
                    let closestIndex = 0;
                    let smallestDiff = Math.abs(currentPos - pagePositions[0]);

                    for (let i = 1; i < pagePositions.length; i++) {
                        const diff = Math.abs(currentPos - pagePositions[i]);
                        if (diff < smallestDiff) {
                            smallestDiff = diff;
                            closestIndex = i;
                        }
                    }
                    return closestIndex;
                }

                // è‡ªåŠ¨å¸é™„åˆ°æœ€è¿‘çš„é¡µé¢
                function autoSnapToPage() {
                    if (scroller.isAutoScrolling) return;

                    const currentPos = smoother.scrollTop();
                    const nearestPage = findNearestPage(currentPos);

                    // å¦‚æœä¸åœ¨å½“å‰é¡µé¢ï¼Œè‡ªåŠ¨å¸é™„
                    if (nearestPage !== scroller.currentPage) {
                        goToPage(nearestPage);
                    }
                }

                // ç›‘å¬æ»šåŠ¨çŠ¶æ€ï¼Œå®ç°è‡ªåŠ¨å¸é™„
                function setupScrollListener() {
                    smoother.scrollTrigger.addEventListener("update", () => {
                        // å¦‚æœæ­£åœ¨è‡ªåŠ¨æ»šåŠ¨ï¼Œä¸å¤„ç†
                        if (scroller.isAutoScrolling) return;

                        // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                        clearTimeout(scroller.scrollTimeout);

                        // è·å–å½“å‰æ»šåŠ¨é€Ÿåº¦
                        const velocity = Math.abs(smoother.getVelocity());

                        // å½“é€Ÿåº¦ä½äºé˜ˆå€¼æ—¶ï¼Œè®¾ç½®è¶…æ—¶æ£€æµ‹æ»šåŠ¨åœæ­¢
                        if (velocity < scroller.velocityThreshold) {
                            scroller.scrollTimeout = setTimeout(autoSnapToPage, 200);
                        }
                    });
                }

                // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬
                setupScrollListener();

                // æŒ‰é’®äº‹ä»¶
                document.getElementById("btn-prev").onclick = () => goToPage(scroller.currentPage - 1);
                document.getElementById("btn-next").onclick = () => goToPage(scroller.currentPage + 1);
                document.getElementById("btn-test").onclick = () => {
                    const { trigger, sections, smoother, horizontalDistance } = window.CpsScroller;
                    console.log(smoother.offset("#step-3", "top"));
                    console.log(smoother.scrollTrigger.start);
                    console.log(smoother.scrollTrigger.end);
                    console.log(parseInt(smoother.scrollTrigger.end * smoother.progress));
                };
            };
        </script>

        <script type="text/javascript">
            window.addEventListener("load", () => {
                initCpsScroller();
                initPagingControls();
            });
        </script>
    </body>
</html>
